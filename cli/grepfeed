#!/usr/bin/env node

'use strict';

let path = require('path')
let util = require('util')

let minimist = require('minimist')
let FeedParser = require('feedparser')
//let Mustache = require('mustache')

let feed = require('../lib/feed')

let errx = function(msg) {
    console.error(path.basename(process.argv[1]) + " error: " + msg)
    process.exit(1)
}

Array.prototype.toString = function() {
    return this.join(", ")
}

let argv = minimist(process.argv.slice(2),
		    { boolean: ['v', 'e', 'x', 'm', 'debug'],
		      string: ['d', 'c', 'n'] })
//console.log(argv)

/*
  filter by:

  -d [-]date[,date]
  -c categories

  by default (in this order): title, summary, description, author

  -e: print only articles w/ enclosures
  -n digit: number of articles to print
  -x: print xml
  -m: print only meta
*/

let feedparser = new FeedParser({ addmeta: false })

feedparser.on('error', function(e) {
    errx(`feedparser: ${e.message}`)
})

feedparser.on('meta', function() {
    if (argv.m) {
	if (argv.debug) {
	    console.log(util.inspect(this.meta, { depth: null }))
	} else {
	    feed.meta2arr(this.meta).forEach( (idx) => {
		let key = Object.keys(idx)[0]
		if (idx[key]) console.log(`${key}: ${idx[key]}`)
	    })
	}
	process.exit(0)
    }
})

let article_count = 1
let article_tprop = {}

feedparser.on('readable', function() {
    let stream = this
    let item

    while ((item = stream.read()) ) {
	if (article_count > 1) console.log("")

//	console.log(item)
	feed.article(item, article_count).forEach( (idx) => {
	    let key = Object.keys(idx)[0]
	    if (article_tprop[key]) return

	    if (idx[key]) {
		if (key.match(/\.__text$/)) article_tprop[key.split(".")[0]] = true
		console.log(`${key}: ${idx[key]}`)
	    }
	})

	article_count++
    }
})

feedparser.on('end', function() {
//    console.log("END")
})

process.stdin.pipe(feedparser)
